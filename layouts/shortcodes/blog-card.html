{{- $url := .Get "url" -}}

{{- $result := try (resources.GetRemote $url) -}}
{{- with $result -}}
    {{- if .Err -}}
        {{ warnf "Error fetching URL: %s" $url .Err }}
        <p style="color: red;">Failed to fetch URL: {{ $url }}</p>
    {{- else -}}
        {{- $content := .Value.Content -}}
        {{- $title := "" -}}
        {{- $description := "" -}}
        {{- $image := "" -}}

        <!-- 抽出された<head>タグ内を探索 -->
        {{- with index (findRE "(?s)<head[^>]*>.*?</head>" $content) 0 -}}
            {{- range $meta := findRE "(?s)<meta[^>]*?>" . -}}
                {{- $name := replaceRE "(?s)<.*?name=\"(.*?)\".*?>" "$1" $meta -}}
                {{- $property := replaceRE "(?s)<.*?property=\"(.*?)\".*?>" "$1" $meta -}}
                {{- $content := replaceRE "(?s)<.*?content=\"(.*?)\".*?>" "$1" $meta -}}

                {{- if eq $property "og:title" -}}
                    {{- $title = $content -}}
                {{- else if eq $property "og:description" -}}
                    {{- $description = $content -}}
                {{- else if eq $property "og:image" -}}
                    {{- $image = $content -}}
                {{- end -}}

                {{- if and (eq $description "") (eq $name "description") -}}
                    {{- $description = $content -}}
                {{- end -}}
            {{- end -}}

            <!-- <title>タグの抽出 -->
            {{- if eq $title "" -}}
                {{- with index (findRE "<title>(.*?)</title>" .) 0 -}}
                    {{- $title = replaceRE "<title>(.*?)</title>" "$1" . -}}
                {{- end -}}
            {{- end -}}
        {{- else -}}
            {{ warnf "Failed to extract <head> from %s" $url }}
        {{- end -}}

        <!-- 画像URLの処理 -->
        {{- if and (ne $image "") (not (hasPrefix $image "http")) -}}
            {{- $image = printf "%s%s" $url $image -}}
        {{- end -}}

        {{- $thumbnail_url := "/noimage.png" -}}
        {{- if ne $image "" -}}
            {{- $thumbnail_url = $image -}}
        {{- end -}}

        <!-- 表示部分 -->
        <a href="{{- $url -}}" style="display: flex; text-decoration: none; color: inherit; margin-bottom: 2rem; padding: 20px; border: 2px solid var(--border); border-radius: 4px; transition: all 0.2s ease; background: var(--theme); box-shadow: none;" onMouseOver="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';" onMouseOut="this.style.borderColor='var(--border)'; this.style.boxShadow='none';" target="_blank">
            <div style="flex: 1; display: flex; flex-direction: column; justify-content: flex-start; padding-right: 20px;">
                <h2 style="margin: 0 0 10px 0; font-size: 18px; font-weight: 700; line-height: 1.4; color: var(--content);">
                    {{- $title -}}
                </h2>
                <p style="margin: 0; font-size: 14px; line-height: 1.6; color: var(--secondary); word-break: break-word; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 3; line-clamp: 3; overflow: hidden;">
                    {{- $description | plainify | safeHTML -}}
                </p>
            </div>
            <div style="flex-shrink: 0; width: 200px; height: 120px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: var(--code-bg); border-radius: 4px;">
                <img src="{{ $thumbnail_url }}" alt="thumbnail" style="width: 100%; height: 100%; object-fit: cover;" />
            </div>
        </a>
    {{- end -}}
{{- end -}}
